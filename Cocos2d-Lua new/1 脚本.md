---
title: 1. 脚本
categories: Cocos2d-Lua
---

### 1 脚本概念

脚本语言是相对于静态编译型语言而言的，它通常在应用程序运行期间通过虚拟机解释执行。因此脚本代码是与平台无关的，引擎可以把代码当作数据处理，在运行期间动态载入内存执行。

Cocos2d-x支持Lua和JavaScript两种脚本语言，同时还提供绑定的机制，让开发者自定义的C++对象可以被脚本访问。

##### 1.1 脚本的分类

广义的脚本实际上可以分为两种：

- 数据定义语言：主要功能在于让用户创建及填充数据结构，这些数据供引擎读取。这些语言通常是声明式的，如HTML、XML、JSON。

- 运行时脚本语言：包含的是引擎可执行代码，在运行时的引擎上下文中执行。这些语言通常用于扩展或定制游戏对象模型/或其他引擎系统的硬编码（是指被编译器翻译成机器码，这些机器码在CPU上执行而不能被运行时修改）。

运行时脚本语言本质上是属于数据定制脚本语言，但是通过结合以属性为中心的对象模型，它也能够实现一些对游戏对象行为的修改。所以他们直接的区别在于游戏引擎是需要解析脚本还是执行脚本。Lua在Cocos2d中属于后者。

##### 1.2 脚本的特征

脚本的特征是解析。大多数脚本语言是直译式的，也称之为动态解释型，动态解释型是相对于静态的编译式语言而言。

（1）执行速度

编译时语言的源码由编译器翻译成机器码，然后机器码直接在cpu上运行，编译器可以可以针对平台进行优化，因而它的执行速度比较快。

直译式的源码可以在运行时直接解析，或是先编译为与平台无关的的字节码，然后这些字节码在在虚拟机中直接执行。直译式语言通常需要一个宿主程序来执行虚拟机，因此它几乎可以移植到任何平台。但是虚拟机执行字节码和速度比原生CPU执行机器码和速度要慢得多。

（2）轻量级

脚本语言相对于原生语言要轻量的多，并且它们的虚拟机比较简单，消耗的内存比较少。例如在Lua中，它以代码段（Chunk）为单位，虚拟机在执行的时候使用一个很小的栈来保存方法、地址及参数，然后将执行结果保存在栈中供原生语言来获取，在执行完一个方法即清空栈。这使得Lua执行速度很快且非常轻量级。

（3）适用场景

由于脚本的解析特征，以及以代码段为单位，因而它特别适合用来对程序的某些方面提供一些定制功能。例如用来发送处理一些事件，实现有限状态机，以及一些对系统的控制。

此外，一些脚本语言是函数式的，其目的是完全避免使用状态。在函数式语言中，程序由一组函数定义，每个函数都不对系统其他数据构成影响。程序的构建方法是由一个函数传送输入参数至另外一个函数，直到取得所需结果。这些语言适合实现一些数据处理管道。

##### 1.3 脚本的架构

脚本在游戏引擎中可以扮演不同的角色，有许多架构可以参考，从简单的脚本代码片段去代表一个游戏对象或引擎系统执行一个简单的功能，到高层的脚本去管理游戏的操作。下面讨论一些可能的脚本：

（1）回调脚本：

在这种架构中，引擎的大部分功能主要是原生语言硬编码的，只有某些关键的小功能设计成可定制的。这些部分通常实现为回调函数。让用户提供一个函数供引擎调用，以实现一些定制。回调函数可以使用脚本编写。例如在游戏循环中更新游戏对象时，引擎可提供一个回调函数，让用户有机会对游戏对象更新方式作一些定制。

（2）事件处理脚本

事件处理器是一种特殊的回调函数，其作用是令游戏对象回应游戏世界发生的事件，例如对爆炸作出反应，或是回应游戏引擎本身的事件，如内存不足。事件处理脚本较回调脚本在实现上更为灵活，例如事件处理脚本可以向一个专门的事件处理器注册事件处理函数，但是回调脚本则可能需要向引擎不同部分注册回调函数。

（3）以脚本扩展游戏对象类型或定义新类型

有些脚本语言可以用脚本扩展原来由原生语言实现的游戏对象模型。例如，在Cocos2d中可以使用Lua派生自Node类来实现一个新的类型。

（4）组件属性脚本

在基于组件或基于属性的游戏对象模型中，只允许使用脚本或部分脚本创建新组件或属性对象，而不能扩展原生的游戏对象模型。例如在《末日危城》中，允许用C++或者Skrit编写属性对象，在项目结束时约有148个脚本属性和21个C++原生对象属性。

（5）脚本驱动的引擎系统

脚本也可以驱动整个引擎系统，例如可以将游戏对象模型完全用脚本编写，仅当需要一些底层引擎组件时才需要调用原生引擎代码。可以想像使用脚本来实现属性模型架构，仅当需要实现渲染、动画、物理等部分的组件时才需要和引擎系统交互。

（6）脚本驱动的游戏

有些语言则完全颠倒原生语言各脚本语言的关系，在这些引擎中，脚本代码是游戏运行的主体，原生引擎代码仅作为程序库。例如在Cocos2d-x中，可以完全使用Lua来编写游戏，而C++的Cocos2d-x引擎作为一个引擎库使用。

##### 1.4 Lua脚本

Lua是一门轻量级、强大、高效的嵌入式脚本语言。据说嵌入式即意味着它需要嵌入到一个宿主程序中执行。宿主程序可以通过调用函数执行一小段Lua代码，以及读写Lua变量，还可以注入C函数让Lua代码调用。Lua提供了一些C函数接口，宿主程序可以通过这些C函数与Lua代码进行交互，这使得Lua可以应用于各种宿主环境，包括游戏引擎，用来扩展宿主程序定制能力。Lua的特性主要有以下：

- 健壮：已经被应用在一些工业程序中、嵌入式系统中。Lua有很好的接口文档。
- 高效：Lua以快而著称，在直译的脚本语言中它几乎是最快的。
- 可移植：Lua可以运行在所有拥有标准C编译器的平台上，包括所有分支的UNIX和Windows平台上，以及移动平台上。
- 可嵌入：Lua是一个嵌入式语言，可以将Lua轻松的嵌入到宿主程序中。
- 轻量：简单而强大解析器和Lua库占用空间小。
- 免费：Lua是开源的。

### 2 Lua脚本语言的功能

不管选何种架构风格，脚本语言在运行时需要具备的功能是一致的。以Lua为例，运行时脚本语言的功能如下：

- 对原生编程语言的接口
- 游戏对象句柄
- 在脚本中接受及处理事件
- 发送事件
- 面向对象脚本语言

在后面章节中将具体介绍Lua和C++的交互以及在游戏引擎中的工作机制。
